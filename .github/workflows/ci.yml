# Continuous integration: run on every push to main and on every PR targeting main.
#
# Jobs:
#   lint-and-test  – go vet, golangci-lint, unit tests (short mode, fast)
#   integration    – full envtest suite (etcd + kube-apiserver); enforces 70% coverage

name: CI

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  lint-and-test:
    name: Lint and test
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          # Reads the go directive from go.mod automatically.
          go-version-file: go.mod
          cache: true

      - name: Verify go.mod is tidy
        run: |
          go mod tidy
          git diff --exit-code go.mod go.sum

      - name: Run go vet
        run: go vet ./...

      # Install golangci-lint from source using the Go toolchain already set up
      # above. Because the binary is compiled by the same Go version declared in
      # go.mod, the internal runtime.Version() check inside golangci-lint always
      # matches the targeted Go version — avoiding the "build version < targeted
      # version" error that pre-built release binaries trigger when a new Go
      # version ships before golangci-lint cuts a new binary release.
      - name: Install golangci-lint
        run: go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest

      - name: Run golangci-lint
        run: golangci-lint run --timeout=5m

      - name: Run unit tests (short)
        run: go test -short -race -coverprofile=coverage.out ./...

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-unit
          path: coverage.out
          retention-days: 7

  integration:
    name: Integration tests (envtest)
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Install envtest binaries
        run: go install sigs.k8s.io/controller-runtime/tools/setup-envtest@latest

      - name: Run integration tests with coverage
        run: |
          KUBEBUILDER_ASSETS=$(setup-envtest use --bin-dir /tmp/envtest-bins -p path)
          export KUBEBUILDER_ASSETS
          go test -race -coverprofile=coverage-integration.out ./...

      - name: Check coverage threshold (70%)
        run: |
          total=$(go tool cover -func=coverage-integration.out | grep '^total:' | awk '{print $3}' | tr -d '%')
          echo "Total coverage: ${total}%"
          if awk "BEGIN {exit !($total < 70)}"; then
            echo "ERROR: coverage ${total}% is below the 70% threshold"
            exit 1
          fi

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-integration
          path: coverage-integration.out
          retention-days: 7
